<%- include('../layouts/adminHead')-%>
<%- include('../layouts/adminSidebarNoS')-%>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<div class="main-panel">
  <div class="content-wrapper">
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Add new product</h4>
          <% if (locals.message) { %>
            <span style="color: red;">
              <%= message %>
            </span>
          <% } %>
          <form class="forms-product" action="/product/AddProduct" method="post" enctype="multipart/form-data">
            <!-- Name -->
            <div class="form-group">
              <label for="exampleInputName1">Name</label>
              <input type="text" class="form-control" id="name" name="name">
              <span class="error-message text-danger" id="name-error-message"></span>
            </div>
            <!-- Unit price -->
            <div class="form-group">
              <label for="price">Unit Price</label>
              <input type="text" class="form-control" name="price" id="price-input" placeholder="Enter numbers only">
              <span class="error-message text-danger" id="price-error-msg"></span>
            </div>
            <!-- Category -->
            <div class="form-group">
              <label for="category">Category</label>
              <select class="form-control" name="category" id="categorySelect">
                <% for(let i=0; i<cat.length; i++){ %>
                  <option><%= cat[i].Name %></option>
                <% } %>
              </select>
              <span class="error-message text-danger" id="category-error-message"></span>
            </div>
            <!-- Quantity -->
            <div class="form-group">
              <label for="quantity">Quantity in Kg</label>
              <input type="text" class="form-control" name="quantity" id="quantity-input" placeholder="Enter numbers only">
              <span class="error-message text-danger" id="quantity-error-message"></span>
            </div>
            <!-- Images -->
            <div class="form-group">
              <label>File upload (Images only, up to 3)</label>
              <!-- Image Upload and Cropper Section 1 -->
              <div class="image-upload-section">
                <input type="file" name="images" id="image-input1" class="form-control file-upload-default" accept="image/*" style="display: none;">
                <div class="input-group col-xs-12">
                  <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image 1">
                  <span class="input-group-append">
                    <button class="file-upload-browse btn btn-gradient-primary" type="button" id="img-upload-btn1">Upload Image 1</button>
                  </span>
                </div>
                <div class="preview-container">
                  <div id="image-preview1" class="preview-image"></div>
                  <button type="button" id="crop-btn1" class="btn btn-primary crop-button" style="display: none;">Crop Image 1</button>
                  <button type="button" id="remove-btn1" class="btn btn-danger remove-button" style="display: none;">Remove Image 1</button>
                </div>
              </div>

              <!-- Image Upload and Cropper Section 2 -->
              <div class="image-upload-section">
                <input type="file" name="images" id="image-input2" class="form-control file-upload-default" accept="image/*" style="display: none;">
                <div class="input-group col-xs-12">
                  <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image 2">
                  <span class="input-group-append">
                    <button class="file-upload-browse btn btn-gradient-primary" type="button" id="img-upload-btn2">Upload Image 2</button>
                  </span>
                </div>
                <div class="preview-container">
                  <div id="image-preview2" class="preview-image"></div>
                  <button type="button" id="crop-btn2" class="btn btn-primary crop-button" style="display: none;">Crop Image 2</button>
                  <button type="button" id="remove-btn2" class="btn btn-danger remove-button" style="display: none;">Remove Image 2</button>
                </div>
              </div>

              <!-- Image Upload and Cropper Section 3 -->
              <div class="image-upload-section">
                <input type="file" name="images" id="image-input3" class="form-control file-upload-default" accept="image/*" style="display: none;">
                <div class="input-group col-xs-12">
                  <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image 3">
                  <span class="input-group-append">
                    <button class="file-upload-browse btn btn-gradient-primary" type="button" id="img-upload-btn3">Upload Image 3</button>
                  </span>
                </div>
                <div class="preview-container">
                  <div id="image-preview3" class="preview-image"></div>
                  <button type="button" id="crop-btn3" class="btn btn-primary crop-button" style="display: none;">Crop Image 3</button>
                  <button type="button" id="remove-btn3" class="btn btn-danger remove-button" style="display: none;">Remove Image 3</button>
                </div>
              </div>
            </div>

            <!-- Description -->
            <div class="form-group">
              <label>Product Description</label>
              <textarea class="form-control" name="description" id="exampleTextarea1" rows="4"></textarea>
            </div>
            <!-- Hidden inputs for cropped image data -->
            <div id="cropped-images-container"></div>
            <button type="submit" class="btn btn-gradient-success mr-2">Submit</button>
            <button class="btn btn-light" onclick="location.href='/product'">Cancel</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('../layouts/adminFooter')-%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const imgUploadBtns = [
      document.getElementById('img-upload-btn1'),
      document.getElementById('img-upload-btn2'),
      document.getElementById('img-upload-btn3')
    ];
    const previewContainers = [
      document.getElementById('image-preview1'),
      document.getElementById('image-preview2'),
      document.getElementById('image-preview3')
    ];
    const cropButtons = [
      document.getElementById('crop-btn1'),
      document.getElementById('crop-btn2'),
      document.getElementById('crop-btn3')
    ];
    const removeButtons = [
      document.getElementById('remove-btn1'),
      document.getElementById('remove-btn2'),
      document.getElementById('remove-btn3')
    ];
    const imageInputs = [
      document.getElementById('image-input1'),
      document.getElementById('image-input2'),
      document.getElementById('image-input3')
    ];

    let croppers = [];

    // Function to initialize Cropper.js for each image
    function initCropper(input, previewContainer, cropButton, removeButton, index) {
      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = function (event) {
        const image = new Image();
        image.src = event.target.result;
        previewContainer.innerHTML = '';
        previewContainer.appendChild(image);

        // Initialize Cropper.js instance
        const cropper = new Cropper(image, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
        });

        croppers[index] = cropper;

        // Show crop and remove buttons for this preview container
        cropButton.style.display = 'block';
        removeButton.style.display = 'block';
      };

      reader.readAsDataURL(file);
    }

    // Event listeners for uploading images and initializing Cropper.js
    imgUploadBtns.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        imageInputs[index].click();
      });
    });

    imageInputs.forEach((input, index) => {
      input.addEventListener('change', () => {
        initCropper(input, previewContainers[index], cropButtons[index], removeButtons[index], index);
      });
    });

    // Event listeners for crop buttons
    cropButtons.forEach((button, index) => {
      button.addEventListener('click', () => {
        const canvas = croppers[index].getCroppedCanvas({
          width: 200, // Set the desired width
          height: 200, // Set the desired height
        });
        if (canvas) {
          canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onloadend = () => {
              const croppedUrl = reader.result;
              previewContainers[index].innerHTML = `<img src="${croppedUrl}" class="preview-image">`;
              imageInputs[index].value = croppedUrl; // Set the value of the original input to the cropped image data
            };
            reader.readAsDataURL(blob);
          });
        }
      });
    });

    // Event listeners for remove buttons
    removeButtons.forEach((button, index) => {
      button.addEventListener('click', () => {
        imageInputs[index].value = '';
        previewContainers[index].innerHTML = '';
        cropButtons[index].style.display = 'none';
        removeButtons[index].style.display = 'none';
        croppers[index] = null;
      });
    });

    // Validation and submission
    const form = document.querySelector('.forms-product');
    const nameInput = document.getElementById('name');
    const priceInput = document.getElementById('price-input');
    const quantityInput = document.getElementById('quantity-input');

    form.addEventListener('submit', (e) => {
      e.preventDefault(); // Prevent the form from submitting initially

      const name = nameInput.value.trim();
      const price = priceInput.value.trim();
      const quantity = quantityInput.value.trim();

      const nameErrorMessage = document.getElementById('name-error-message');
      const priceErrorMessage = document.getElementById('price-error-msg');
      const quantityErrorMessage = document.getElementById('quantity-error-message');

      nameErrorMessage.textContent = '';
      priceErrorMessage.textContent = '';
      quantityErrorMessage.textContent = '';

      let isValid = true;

      // Name Validation
      if (name === '') {
        isValid = false;
        nameErrorMessage.textContent = 'Please enter a valid name';
      }

      // Price Validation
      if (!price.match(/^\d+(\.\d{1,2})?$/)) {
        isValid = false;
        priceErrorMessage.textContent = 'Please enter a valid price (numbers only)';
      }

      // Quantity Validation
      if (!quantity.match(/^\d+(\.\d{1,2})?$/)) {
        isValid = false;
        quantityErrorMessage.textContent = 'Please enter a valid quantity (numbers only)';
      }

      if (isValid) {
        // Submit the form after all validations pass
        form.submit();
      }
    });
  });
</script>

<style>
  .preview-container {
    display: flex;
    gap: 20px; /* Adjust as needed */
    align-items: center; /* Center align items vertically */
  }

  .preview-image {
    width: 100px; /* Adjust the size of the cropped images */
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer; /* Add cursor pointer for interactivity */
    transition: transform 0.2s ease; /* Add smooth transition on hover */
    margin-right: 10px; /* Add margin for horizontal alignment */
  }

  .preview-image:hover {
    transform: scale(1.1); /* Scale up the image on hover */
  }

  .crop-button,
  .remove-button {
    margin-top: 10px; /* Add margin for vertical alignment */
  }

  .crop-button {
    margin-right: 10px; /* Add margin to separate crop and remove buttons */
  }
</style>
