<%- include('../layouts/adminHead') %>
<%- include('../layouts/adminSidebarNoS') %>

<div class="main-panel">
  <div class="content-wrapper">
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Edit Product</h4>
          <% if (locals.message) { %>
            <span style="color: red;">
              <%= message %>
            </span>
          <% } %>
          <form class="forms-product" enctype="multipart/form-data" method="POST" action="/product/editProduct?pid=<%= product._id %>">
            <!-- Name -->
            <div class="form-group">
              <label for="exampleInputName1">Name</label>
              <input type="text" class="form-control" id="name" name="name" value="<%= product.Name %>" title="Please enter letters and spaces only">
              <span class="error-message text-danger" id="name-error-message"></span>
            </div>

            <!-- Unit Price -->
            <div class="form-group">
              <label for="price">Unit Price</label>
              <input type="text" class="form-control" name="price" id="price-input" value="<%= product.Price %>">
              <span class="error-message text-danger" id="price-error-msg"></span>
            </div>

            <!-- Category -->
            <div class="form-group">
              <label for="category">Category</label>
              <select class="form-control" name="category" id="categorySelect">
                <% for (let i = 0; i < cat.length; i++) { %>
                  <option <%= cat[i].Name === product.Category.Name ? 'selected' : '' %>>
                    <%= cat[i].Name %>
                  </option>
                <% } %>
              </select>
              <span class="error-message text-danger" id="category-error-message"></span>
            </div>

            <!-- Quantity -->
            <div class="form-group">
              <label for="quantity">Quantity in Kg</label>
              <input type="text" class="form-control" name="quantity" id="quantity-input" value="<%= product.Quantity %>">
              <span class="error-message text-danger" id="quantity-error-message"></span>
            </div>

            <!-- Images -->
            <div class="form-group">
              <label>File upload (Images only)</label>
              <input type="file" name="images" id="image-input" class="form-control file-upload-default" multiple accept="image/*">
              <div class="input-group col-xs-12">
                <input type="text" class="form-control file-upload-info" disabled placeholder="Upload Image">
                <span class="input-group-append">
                  <button class="file-upload-browse btn btn-gradient-primary" type="button" id="img-upload-btn">Upload</button>
                </span>
              </div>
              <span id="image-error-message" class="error-message text-danger"></span>
              <!-- Existing Image with Cross Marks -->
              <div class="image-preview d-flex mt-2">
                <% for (let i = 0; i < product.Image.length; i++) { %>
                  <div class="mr-2 image-container">
                    <button class="remove-image-btn" data-index="<%= i %>" type="button">&times;</button>
                    <img src="/productimages/<%= product.Image[i] %>" width="100px">
                  </div>
                <% } %>
              </div>
            </div>

            <!-- Image Previews -->
            <div id="image-preview" class="preview-container"></div><br>

            <!-- Description -->
            <div class="form-group">
              <label>Product Description</label>
              <textarea class="form-control" name="description" id="exampleTextarea1" rows="4"><%= product.Pdesc %></textarea>
            </div>

            <button type="submit" class="btn btn-gradient-success mr-2">Submit</button>
          </form>
          <button class="btn btn-light" onclick="location.href='/product'">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../layouts/adminFooter') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.forms-product');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    let cropper;

    imageInput.addEventListener('change', () => {
      if (cropper) {
        cropper.destroy();
      }

      const files = imageInput.files;
      const maxPreviewImages = 3;

      imagePreview.innerHTML = '';

      for (let i = 0; i < maxPreviewImages && i < files.length; i++) {
        const reader = new FileReader();

        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.classList.add('preview-image');
          imagePreview.appendChild(img);

          cropper = new Cropper(img, {
            aspectRatio: 1,
            viewMode: 1,
            background: false,
          });
        };

        reader.readAsDataURL(files[i]);
      }
    });

    form.addEventListener('submit', (e) => {
      const nameInput = document.getElementById('name');
      const priceInput = document.getElementById('price-input');
      const quantityInput = document.getElementById('quantity-input');
      const imagesInput = document.getElementById('image-input');

      const nameErrorMessage = document.getElementById('name-error-message');
      const priceErrorMessage = document.getElementById('price-error-msg');
      const quantityErrorMessage = document.getElementById('quantity-error-message');
      const imagesErrorMessage = document.getElementById('image-error-message');

      const name = nameInput.value.trim();
      const price = priceInput.value.trim();
      const quantity = quantityInput.value.trim();
      const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp', 'JPG', 'JPEG', 'WEBP'];
      const files = imagesInput.files;

      let isValid = true;

      nameErrorMessage.textContent = '';
      priceErrorMessage.textContent = '';
      quantityErrorMessage.textContent = '';
      imagesErrorMessage.textContent = '';

      if (name === '') {
        isValid = false;
        nameErrorMessage.textContent = 'Please enter a valid name';
      } else {
        nameInput.value = name;
      }

      if (!price.match(/^\d+(\.\d{1,2})?$/)) {
        isValid = false;
        priceErrorMessage.textContent = 'Please enter a valid price (numbers only)';
      } else {
        priceInput.value = price;
      }

      if (!quantity.match(/^\d+(\.\d{1,2})?$/)) {
        isValid = false;
        quantityErrorMessage.textContent = 'Please enter a valid quantity (numbers only)';
      } else {
        quantityInput.value = quantity;
      }

      let fileIsValid = true;

      for(let i = 0; i < files.length; i++) {
const fileName = files[i].name;
const fileExtension = fileName.split('.').pop().toLowerCase();
if (!allowedExtensions.includes(fileExtension)) {
      fileIsValid = false;
      break;
    }
  }

  if (!fileIsValid) {
    isValid = false;
    imagesErrorMessage.textContent = 'Please upload only JPG, JPEG, PNG, or WEBP files';
  }

  if (!isValid) {
    e.preventDefault();
    if (cropper) {
      cropper.destroy();
    }
    return;
  }

  // Prepare cropped images for submission
  const croppedImages = [];
  const croppedCanvas = cropper.getCroppedCanvas({ width: 300, height: 300 }); // Adjust dimensions as needed

  if (croppedCanvas) {
    croppedCanvas.toBlob((blob) => {
      const croppedFile = new File([blob], 'cropped_image.jpg', { type: 'image/jpeg', lastModified: Date.now() });
      croppedImages.push(croppedFile);

      // Append cropped images to the form data
      const formData = new FormData(form);
      for (const image of croppedImages) {
        formData.append('croppedImages', image);
      }

      // Submit the form with cropped images
      fetch(form.action, {
        method: form.method,
        body: formData,
      })
        .then(response => response.json())
        .then(data => {
          console.log(data);
          // Handle response as needed
        })
        .catch(error => {
          console.error('Error:', error);
          // Handle error
        });
    }, 'image/jpeg');
  } else {
    // No images cropped
    const formData = new FormData(form);
    fetch(form.action, {
      method: form.method,
      body: formData,
    })
      .then(response => response.json())
      .then(data => {
        console.log(data);
        // Handle response as needed
      })
      .catch(error => {
        console.error('Error:', error);
        // Handle error
      });
  }
});

// Add event listeners for upload and remove buttons
const imgUploadBtn = document.getElementById('img-upload-btn');
imgUploadBtn.addEventListener('click', () => {
  imageInput.click();
});

const removeImageBtns = document.querySelectorAll('.remove-image-btn');
removeImageBtns.forEach(btn => {
  btn.addEventListener('click', (e) => {
    const index = e.target.dataset.index;
    // Remove the corresponding image from the preview
    const imageContainer = document.querySelector(`.image-container[data-index="${index}"]`);
    if (imageContainer) {
      imageContainer.remove();
    }
    // Remove the corresponding file from the input
    const filesToRemove = Array.from(imageInput.files);
    filesToRemove.splice(index, 1);
    imageInput.files = new FileList({ items: filesToRemove });
  });
});
});
</script>
